#!/usr/bin/env bash
# Health check automation script for Neovim config

set -e

echo "ðŸ¥ Neovim Configuration Health Check"
echo "===================================="
echo ""

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check 1: Neovim version
echo -e "${BLUE}1. Checking Neovim version...${NC}"
if command -v nvim &> /dev/null; then
    NVIM_VERSION=$(nvim --version | head -1)
    echo "   $NVIM_VERSION"
    echo -e "   ${GREEN}âœ“ Neovim is installed${NC}"
else
    echo -e "   ${RED}âœ— Neovim not found${NC}"
    exit 1
fi
echo ""

# Check 2: Required CLIs
echo -e "${BLUE}2. Checking required CLI tools...${NC}"
REQUIRED_TOOLS=("luacheck" "stylua" "rg" "fd" "node")
for tool in "${REQUIRED_TOOLS[@]}"; do
    if command -v "$tool" &> /dev/null; then
        VERSION=$("$tool" --version 2>&1 | head -1 || echo "installed")
        echo -e "   ${GREEN}âœ“${NC} $tool: $VERSION"
    else
        echo -e "   ${YELLOW}âš ${NC} $tool: not found"
    fi
done
echo ""

# Check 3: Luacheck
echo -e "${BLUE}3. Running luacheck...${NC}"
cd "$(dirname "$0")/.." || exit 1
if luacheck lua/ --quiet; then
    WARNINGS=$(luacheck lua/ 2>&1 | grep "warnings / " | grep -oE "[0-9]+ warnings" || echo "0 warnings")
    echo -e "   ${GREEN}âœ“ Luacheck passed${NC} ($WARNINGS)"
else
    echo -e "   ${RED}âœ— Luacheck failed${NC}"
    echo "   Run: luacheck lua/ (for details)"
fi
echo ""

# Check 4: Neovim loads successfully
echo -e "${BLUE}4. Testing Neovim loads...${NC}"
if timeout 10 nvim --headless "+lua print('Health check: OK')" +qa 2>&1 | grep -q "OK"; then
    echo -e "   ${GREEN}âœ“ Neovim loads successfully${NC}"
else
    echo -e "   ${RED}âœ— Neovim failed to load${NC}"
fi
echo ""

# Check 5: Startup time
echo -e "${BLUE}5. Measuring startup performance...${NC}"
nvim --startuptime /tmp/nvim_health_startup.log --headless +qa 2>&1
STARTUP_TIME=$(grep "NVIM STARTED" /tmp/nvim_health_startup.log | awk '{print $1}')
echo "   Startup time: ${STARTUP_TIME}ms"
if (( $(echo "$STARTUP_TIME < 150" | bc -l) )); then
    echo -e "   ${GREEN}âœ“ Under 150ms target${NC}"
elif (( $(echo "$STARTUP_TIME < 500" | bc -l) )); then
    echo -e "   ${YELLOW}âš  Acceptable (150-500ms)${NC}"
else
    echo -e "   ${RED}âœ— Slow (>500ms)${NC}"
fi
echo ""

# Check 6: Plugin directory
echo -e "${BLUE}6. Checking plugin directory...${NC}"
PLUGIN_DIR="$HOME/.local/share/nvim/lazy"
if [ -d "$PLUGIN_DIR" ]; then
    PLUGIN_COUNT=$(find "$PLUGIN_DIR" -maxdepth 1 -type d | wc -l)
    echo -e "   ${GREEN}âœ“ Plugin directory exists${NC}"
    echo "   Plugins installed: $((PLUGIN_COUNT - 1))"
else
    echo -e "   ${YELLOW}âš  Plugin directory not found${NC}"
    echo "   Plugins will be installed on first run"
fi
echo ""

# Check 7: Config file structure
echo -e "${BLUE}7. Checking config structure...${NC}"
REQUIRED_FILES=("init.lua" "lua/options.lua" "lua/mappings.lua" "lua/plugins.lua" "lua/autocmd.lua")
ALL_FOUND=true
for file in "${REQUIRED_FILES[@]}"; do
    if [ -f "$file" ]; then
        echo -e "   ${GREEN}âœ“${NC} $file"
    else
        echo -e "   ${RED}âœ—${NC} $file (missing)"
        ALL_FOUND=false
    fi
done
if $ALL_FOUND; then
    echo -e "   ${GREEN}âœ“ All core files present${NC}"
fi
echo ""

# Check 8: Documentation
echo -e "${BLUE}8. Checking documentation...${NC}"
DOCS=("AGENTS.md" "KEYMAPS.md" "LSP.md" "PERFORMANCE.md")
for doc in "${DOCS[@]}"; do
    if [ -f "$doc" ]; then
        echo -e "   ${GREEN}âœ“${NC} $doc"
    else
        echo -e "   ${YELLOW}âš ${NC} $doc (missing)"
    fi
done
echo ""

# Summary
echo "===================================="
echo -e "${GREEN}ðŸŽ‰ Health check complete!${NC}"
echo ""
echo "For detailed health check: nvim +checkhealth"
echo "For startup profiling: nvim +StartupTime"
echo ""
