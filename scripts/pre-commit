#!/usr/bin/env bash
# Pre-commit hook for Neovim config
# Install: ln -s ../../scripts/pre-commit .git/hooks/pre-commit

set -e

echo "ðŸ” Running pre-commit checks..."
echo ""

# Change to config directory
cd "$(dirname "$0")/../.." || exit 1

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track overall status
FAILED=0

# Check 1: Luacheck
echo "ðŸ“ Running luacheck..."
if luacheck lua/ --quiet; then
    echo -e "${GREEN}âœ“ Luacheck passed${NC}"
else
    echo -e "${RED}âœ— Luacheck failed${NC}"
    echo "  Fix errors with: luacheck lua/"
    FAILED=1
fi
echo ""

# Check 2: Stylua (format check only, don't auto-fix in pre-commit)
echo "ðŸŽ¨ Checking Lua formatting..."
if stylua --check . 2>&1 | grep -q "Diff"; then
    echo -e "${YELLOW}âš  Code needs formatting${NC}"
    echo "  Run: stylua ."
    FAILED=1
else
    echo -e "${GREEN}âœ“ Formatting is correct${NC}"
fi
echo ""

# Check 3: Check for common issues
echo "ðŸ”Ž Checking for common issues..."

# Check for trailing whitespace in Lua files
if git diff --cached --name-only | grep '\.lua$' | xargs grep -l '[[:space:]]$' 2>/dev/null; then
    echo -e "${YELLOW}âš  Found trailing whitespace in Lua files${NC}"
    echo "  Fix with: sed -i '' 's/[[:space:]]*$//' <file>"
    FAILED=1
fi

# Check for debugger statements
if git diff --cached --name-only | grep '\.lua$' | xargs grep -l 'vim.print\|print(' 2>/dev/null; then
    echo -e "${YELLOW}âš  Found print/debug statements${NC}"
    echo "  Remove debug statements before committing"
    # Don't fail, just warn
fi

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}âœ“ All checks passed${NC}"
else
    echo ""
    echo -e "${GREEN}All checks completed${NC}"
fi
echo ""

# Quick Neovim load test
echo "ðŸš€ Testing Neovim loads..."
if timeout 10 nvim --headless "+lua print('Pre-commit: Neovim loads successfully')" +qa 2>&1 | grep -q "successfully"; then
    echo -e "${GREEN}âœ“ Neovim loads without errors${NC}"
else
    echo -e "${RED}âœ— Neovim failed to load${NC}"
    FAILED=1
fi
echo ""

if [ $FAILED -eq 1 ]; then
    echo -e "${RED}Pre-commit checks failed. Commit aborted.${NC}"
    echo "Run checks manually: ./scripts/pre-commit"
    exit 1
fi

echo -e "${GREEN}ðŸŽ‰ All pre-commit checks passed!${NC}"
exit 0
