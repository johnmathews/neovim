#!/usr/bin/env bash
# Pre-commit hook for Neovim config
# Runs quality gate + git-specific checks before each commit:
#   - Quality gate (stylua, luacheck, Neovim load test)
#   - Trailing whitespace detection in staged .lua files
#   - Debug statement detection (warning only)
# Install: ln -s ../../scripts/pre-commit .git/hooks/pre-commit

set -e

echo "üîç Running pre-commit checks..."
echo ""

# Change to config directory
cd "$(dirname "$0")/../.." || exit 1

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track overall status
FAILED=0

# Step 1: Run quality gate
echo "üìã Running quality gate..."
if ./scripts/quality-gate; then
  echo -e "${GREEN}‚úì Quality gate passed${NC}"
else
  echo -e "${RED}‚úó Quality gate failed${NC}"
  FAILED=1
fi
echo ""

# Step 2: Git-specific checks on staged files
echo "üîé Checking staged files for common issues..."

# Only check Lua files if there are any staged
LUA_FILES=$(git diff --cached --name-only | grep '\.lua$' || true)

if [ -n "$LUA_FILES" ]; then
  # Check for trailing whitespace in staged Lua files
  if echo "$LUA_FILES" | xargs grep -l '[[:space:]]$' 2>/dev/null; then
    echo -e "${YELLOW}‚ö† Found trailing whitespace in staged Lua files${NC}"
    echo "  Fix with: sed -i '' 's/[[:space:]]*$//' <file>"
    FAILED=1
  fi

  # Check for debug statements (warning only, don't block)
  DEBUG_FILES=$(echo "$LUA_FILES" | grep -v '^test/' || true)
  if [ -n "$DEBUG_FILES" ]; then
    if echo "$DEBUG_FILES" | xargs grep -l 'vim.print\|print(' 2>/dev/null; then
      echo -e "${YELLOW}‚ö† Found print/debug statements in staged files${NC}"
      echo "  Consider removing debug statements before committing"
    fi
  fi
fi

if [ $FAILED -eq 0 ]; then
  echo -e "${GREEN}‚úì All git-specific checks passed${NC}"
fi
echo ""

# Summary
if [ $FAILED -eq 1 ]; then
  echo -e "${RED}‚ùå Pre-commit checks failed. Commit aborted.${NC}"
  echo "Run checks manually: ./scripts/pre-commit"
  exit 1
fi

echo -e "${GREEN}üéâ All pre-commit checks passed!${NC}"
exit 0
