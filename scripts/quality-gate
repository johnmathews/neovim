#!/usr/bin/env bash
# Complete quality gate check (format + lint + load test)
# Run before committing or pushing

set -e

echo "üîí Running complete quality gate..."
echo ""

cd "$(dirname "$0")/.." || exit 1

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

FAILED=0

# Step 1: Format check
echo "1Ô∏è‚É£  Checking formatting (stylua)..."
if stylua --check . 2>&1 | grep -q "Diff"; then
    echo -e "${RED}   ‚úó Formatting check failed${NC}"
    echo "   Run: stylua ."
    FAILED=1
else
    echo -e "${GREEN}   ‚úì Formatting correct${NC}"
fi
echo ""

# Step 2: Lint
echo "2Ô∏è‚É£  Running linter (luacheck)..."
if luacheck lua/ --quiet; then
    echo -e "${GREEN}   ‚úì Luacheck passed${NC}"
else
    echo -e "${RED}   ‚úó Luacheck failed${NC}"
    FAILED=1
fi
echo ""

# Step 3: Load test
echo "3Ô∏è‚É£  Testing Neovim loads..."
if timeout 10 nvim --headless "+lua print('Quality gate: OK')" +qa 2>&1 | grep -q "OK"; then
    echo -e "${GREEN}   ‚úì Neovim loads successfully${NC}"
else
    echo -e "${RED}   ‚úó Neovim failed to load${NC}"
    FAILED=1
fi
echo ""

# Summary
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}üéâ Quality gate passed!${NC}"
    echo ""
    echo "Safe to commit and push."
    exit 0
else
    echo -e "${RED}‚ùå Quality gate failed!${NC}"
    echo ""
    echo "Fix errors before committing."
    exit 1
fi
